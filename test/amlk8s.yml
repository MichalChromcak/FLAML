description: finetuning test on AMLK8s

target:
  service: amlk8s
  name: ms-shared-v100

environment:
  image: sonichi/hpo4hf:latest
  setup:
    # - pip install transformers datasets wandb prompt_toolkit==1.0.14 --user
    # - sudo apt-get -y install git
    # - export TMPDIR="./data/"
    # - mkdir ./data/
    - git clone https://github.com/liususan091219/FLAML.git
    - cd FLAML
    - git checkout v0.2.7
    - pip install -e.[blendsearch,ray] --user
    - export WANDB_MODE=disabled
    - export WANDB_API_KEY=7553d982a2247ca8324ec648bd302678105e1058
    # - cd ..
    # - git clone https://github.com/NVIDIA/apex
    # - cd apex
    # - pip install --user -v --no-cache-dir --global-option="--cpp_ext" --global-option="--cuda_ext" ./
    # - cd ..
    # - rm -rf apex/.git

code:
  # local directory of the code. this will be uploaded to the server.
  # $CONFIG_DIR is expanded to the directory of this config file
  local_dir: $CONFIG_DIR/hf/

# data:
#   data upload is not required for this example

parameters:
  subdataset_names: ["rte", "mrpc", "cola", "sst2"]
  model_names: ["electra_small", "electra_base", "bert", "roberta", "deberta"]

jobs:
- ${{ each model in parameters.model_names }}
  - name: ${{ model }}_rte_hpo
    sku: 32G4
    command:
    - python run_autohf.py --dataset_idx 0 --model_name ${{ model }} --server_name azureml --algo hpo --suffix ${{ model }}_rte_hpo --data_root_dir "./data/" --sample_num 64 --time_budget 3600
    submit_args: &retry_args
    # Max numbers of attempts to retry job. Default: 3.
      max_attempts: 0
- ${{ each model in parameters.model_names }}
  - name: ${{ model }}_cola_hpo
    sku: 32G4
    command:
    - python run_autohf.py --dataset_idx 2 --model_name ${{ model }} --server_name azureml --algo hpo --suffix ${{ model }}_cola_hpo --data_root_dir "./data/" --sample_num 64 --time_budget 7200
    submit_args:
      <<: *retry_args